name: sync common images

on:
  workflow_dispatch:
    inputs:
      common_images:
        description: "Images to sync (comma-separated, e.g., node:24.12.0-alpine,python:3.14.2-slim)"
        required: true
        type: string

env:
  REGISTRY: ${{ vars.ALIYUN_CR_REGISTRY }}
  NAMESPACE: ${{ vars.ALIYUN_CR_NAMESPACE_MODU }}

jobs:
  sync-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Install crane
        run: |
          # aliyun ACR å¯¹ QPS æœ‰é™åˆ¶ï¼Œä½¿ç”¨ docker buildx imagetools create ä¼šè§¦å‘ 429 Too Many Requests
          # å®‰è£… crane - Google çš„å®¹å™¨é•œåƒå·¥å…·ï¼Œæ”¯æŒ --jobs å‚æ•°é™åˆ¶å¹¶å‘
          VERSION=$(curl -s "https://api.github.com/repos/google/go-containerregistry/releases/latest" | jq -r '.tag_name')
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar -xzf - -C /usr/local/bin crane
          chmod +x /usr/local/bin/crane
          crane version
      
      - name: Login to registries
        run: |
          # ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
          echo "${{ secrets.ALIYUN_CR_PASSWORD }}" | crane auth login ${{ env.REGISTRY }} -u "${{ secrets.ALIYUN_CR_USERNAME }}" --password-stdin
          echo "âœ… Logged in to ${{ env.REGISTRY }}"

      - name: Sync images
        id: sync
        run: |
          set +e  # ä¸å› å•ä¸ªå‘½ä»¤å¤±è´¥è€Œé€€å‡ºï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†æ‰€æœ‰ç»“æœ

          IMAGE_LIST="${{ github.event.inputs.common_images }}"
          if [[ -z "$IMAGE_LIST" ]]; then
            echo "âŒ common_images input is empty"
            exit 1
          fi

          echo "ğŸ“‹ Images to sync: $IMAGE_LIST"

          success_list=""
          failed_list=""
          success_count=0
          failed_count=0

          IFS=',' read -ra IMAGES <<< "$IMAGE_LIST"
          for image in "${IMAGES[@]}"; do
            # æ¸…ç†ç©ºæ ¼ï¼Œè¡¥å…… tag
            image=$(echo "$image" | xargs)
            [[ -z "$image" ]] && continue
            [[ "$image" != *":"* ]] && image="${image}:latest"

            echo ""
            echo "ğŸ“¦ Processing: $image"

            # ç”Ÿæˆç›®æ ‡é•œåƒåï¼šç§»é™¤ registry å‰ç¼€ï¼Œæ–œæ è½¬è¿å­—ç¬¦
            if [[ "$image" == *"."*"/"* ]]; then
              name_part=$(echo "$image" | cut -d'/' -f2-)
            else
              name_part="$image"
            fi
            target_name=$(echo "$name_part" | sed 's/\//-/g')
            target="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${target_name}"

            echo "  â†’ Target: $target"
            echo "  â³ Syncing..."

            # æ ¸å¿ƒåŒæ­¥ï¼šä½¿ç”¨ crane å¤åˆ¶å¤šå¹³å°é•œåƒ
            # æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼ˆ15åˆ†é’Ÿï¼‰å’Œè¿›åº¦ç›‘æ§
            start_time=$(date +%s)
            sync_output=$(mktemp)
            
            # åœ¨åå°è¿è¡Œè¿›åº¦ç›‘æ§ï¼ˆæ¯30ç§’è¾“å‡ºä¸€æ¬¡å¿ƒè·³ï¼‰
            (
              while true; do
                sleep 30
                elapsed=$(($(date +%s) - start_time))
                echo "  â³ Still syncing... (${elapsed}s elapsed)" >&2
              done
            ) &
            progress_pid=$!
            
            # æ‰§è¡ŒåŒæ­¥å‘½ä»¤ï¼ˆä½¿ç”¨ craneï¼‰
            # --jobs 1: é™åˆ¶å¹¶å‘ä¸º 1ï¼Œé¿å…è§¦å‘ 429 é™æµ
            # --platform all: å¤åˆ¶æ‰€æœ‰å¹³å°çš„é•œåƒï¼ˆå¤šæ¶æ„æ”¯æŒï¼‰
            sync_success=false
            max_retries=5
            retry_delay=60  # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
            
            for ((retry=1; retry<=max_retries; retry++)); do
              if timeout 900 crane copy \
                --jobs 1 \
                --platform all \
                "${image}" \
                "${target}" > "$sync_output" 2>&1; then
                sync_success=true
                break
              else
                sync_exit_code=$?
                # æ£€æŸ¥æ˜¯å¦æ˜¯ 429 é™æµé”™è¯¯
                if grep -qiE "(429|too many|rate limit)" "$sync_output" 2>/dev/null; then
                  if [[ $retry -lt $max_retries ]]; then
                    current_delay=$((retry_delay * retry))  # æŒ‡æ•°é€€é¿
                    echo "  âš ï¸  Rate limited, waiting ${current_delay}s before retry $((retry+1))/${max_retries}..."
                    sleep $current_delay
                    continue
                  fi
                fi
                # éé™æµé”™è¯¯æˆ–å·²ç”¨å°½é‡è¯•æ¬¡æ•°ï¼Œé€€å‡ºå¾ªç¯
                break
              fi
            done
            
            # åœæ­¢è¿›åº¦ç›‘æ§ï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰
            kill $progress_pid 2>/dev/null || true
            wait $progress_pid 2>/dev/null || true
            
            # å¤„ç†ç»“æœ
            if [[ "$sync_success" == "true" ]]; then
              end_time=$(date +%s)
              duration=$((end_time - start_time))
              
              # æ£€æŸ¥è¾“å‡ºä¸­æ˜¯å¦æœ‰æˆåŠŸæ ‡è¯†
              echo "  âœ… Synced successfully"
              # æ˜¾ç¤ºæ‘˜è¦ä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºå‰å‡ è¡Œå…³é”®ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨ï¼‰
              if [[ -s "$sync_output" ]]; then
                if grep -qE "(digest:|sha256:)" "$sync_output" 2>/dev/null; then
                  grep -E "(digest:|sha256:)" "$sync_output" 2>/dev/null | head -3 | sed 's/^/    /' 2>/dev/null || true
                else
                  # å¦‚æœæ²¡æœ‰æ‰¾åˆ° digestï¼Œæ˜¾ç¤ºæœ€åå‡ è¡Œè¾“å‡ºä½œä¸ºå‚è€ƒ
                  tail -5 "$sync_output" 2>/dev/null | sed 's/^/    /' 2>/dev/null || true
                fi
              fi
              
              echo "  â±ï¸  Completed in ${duration}s"
              success_list="${success_list}${image} -> ${target}\n"
              ((success_count++))
            else
              end_time=$(date +%s)
              duration=$((end_time - start_time))
              
              if [[ ${sync_exit_code:-0} -eq 124 ]]; then
                echo "  â±ï¸  Timeout after ${duration}s"
                failed_list="${failed_list}${image} (timeout)\n"
              else
                echo "  âŒ Failed (exit code: ${sync_exit_code:-unknown}, took ${duration}s)"
                # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if [[ -s "$sync_output" ]]; then
                  echo "  Error output:"
                  tail -20 "$sync_output" | sed 's/^/    /' || true
                fi
                failed_list="${failed_list}${image}\n"
              fi
              ((failed_count++))
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "$sync_output"
            
            # æ·»åŠ å»¶è¿Ÿé¿å…è§¦å‘é€Ÿç‡é™åˆ¶ (429 Too Many Requests)
            # åªæœ‰å¤šä¸ªé•œåƒæ—¶æ‰éœ€è¦ç­‰å¾…
            if [[ ${#IMAGES[@]} -gt 1 ]]; then
              echo "  ğŸ’¤ Waiting 10s before next image to avoid rate limiting..."
              sleep 10
            fi
          done

          # è¾“å‡ºåˆ° GitHub ç¯å¢ƒå˜é‡
          echo "success_count=$success_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT

          # ä½¿ç”¨ heredoc ä¿å­˜å¤šè¡Œå†…å®¹
          # ç¡®ä¿å³ä½¿åˆ—è¡¨ä¸ºç©ºä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
          if [[ -n "$success_list" ]]; then
            {
              echo "success_list<<EOF"
              echo -e "$success_list"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "success_list=" >> $GITHUB_OUTPUT
          fi

          if [[ -n "$failed_list" ]]; then
            {
              echo "failed_list<<EOF"
              echo -e "$failed_list"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "failed_list=" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "ğŸ“Š Summary: $success_count succeeded, $failed_count failed"
          
          # è°ƒè¯•ä¿¡æ¯
          echo "ğŸ” Debug: success_count=$success_count, failed_count=$failed_count"
          echo "ğŸ” Debug: Total images processed: $((success_count + failed_count))"

          # å¦‚æœå…¨éƒ¨å¤±è´¥åˆ™é€€å‡º
          if [[ $success_count -eq 0 && $failed_count -gt 0 ]]; then
            echo "âŒ All images failed to sync"
            exit 1
          fi
          
          # å¦‚æœæœ‰æˆåŠŸçš„ï¼Œå³ä½¿æœ‰å¤±è´¥çš„ä¹Ÿè¿”å›æˆåŠŸï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰
          if [[ $success_count -gt 0 ]]; then
            echo "âœ… Sync completed with $success_count success(es)"
            exit 0
          fi
          
          # å¦‚æœæ²¡æœ‰ä»»ä½•é•œåƒå¤„ç†ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
          if [[ $success_count -eq 0 && $failed_count -eq 0 ]]; then
            echo "âš ï¸  No images were processed"
            exit 0
          fi
          
          exit 0

      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸš€ Image Sync Results

          | Metric | Value |
          |--------|-------|
          | âœ… Succeeded | ${{ steps.sync.outputs.success_count || 0 }} |
          | âŒ Failed | ${{ steps.sync.outputs.failed_count || 0 }} |
          | Registry | `${{ env.REGISTRY }}` |
          | Namespace | `${{ env.NAMESPACE }}` |

          EOF

          if [[ -n "${{ steps.sync.outputs.success_list }}" ]]; then
            echo "### âœ… Succeeded" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.sync.outputs.success_list }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ steps.sync.outputs.failed_list }}" ]]; then
            echo "### âŒ Failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.sync.outputs.failed_list }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
