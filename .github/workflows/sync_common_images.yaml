name: sync common images

on:
  workflow_dispatch:

env:
  REGISTRY: ${{ vars.ALIYUN_CR_REGISTRY }}
  NAMESPACE: ${{ vars.ALIYUN_CR_NAMESPACE_MODU }}
  COMMON_IMAGES: ${{ vars.ALIYUN_CR_COMMON_IMAGES }}

jobs:
  sync-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_CR_USERNAME }}
          password: ${{ secrets.ALIYUN_CR_PASSWORD }}

      - name: Sync images
        id: sync
        run: |
          # ÂàùÂßãÂåñ buildx
          docker buildx create --name multiarch --driver docker-container --use
          docker buildx inspect --bootstrap

          IMAGE_LIST="${{ env.COMMON_IMAGES }}"
          if [[ -z "$IMAGE_LIST" ]]; then
            echo "‚ùå COMMON_IMAGES is empty"
            exit 1
          fi

          echo "üìã Images to sync: $IMAGE_LIST"

          success_list=""
          failed_list=""
          success_count=0
          failed_count=0

          IFS=',' read -ra IMAGES <<< "$IMAGE_LIST"
          for image in "${IMAGES[@]}"; do
            # Ê∏ÖÁêÜÁ©∫Ê†ºÔºåË°•ÂÖÖ tag
            image=$(echo "$image" | xargs)
            [[ -z "$image" ]] && continue
            [[ "$image" != *":"* ]] && image="${image}:latest"

            echo ""
            echo "üì¶ Processing: $image"

            # ÁîüÊàêÁõÆÊ†áÈïúÂÉèÂêçÔºöÁßªÈô§ registry ÂâçÁºÄÔºåÊñúÊù†ËΩ¨ËøûÂ≠óÁ¨¶
            if [[ "$image" == *"."*"/"* ]]; then
              name_part=$(echo "$image" | cut -d'/' -f2-)
            else
              name_part="$image"
            fi
            target_name=$(echo "$name_part" | sed 's/\//-/g')
            target="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${target_name}"

            echo "  ‚Üí Target: $target"
            echo "  ‚è≥ Syncing..."

            # Ê†∏ÂøÉÂêåÊ≠•Ôºö‰ΩøÁî® imagetools Áõ¥Êé•Â§çÂà∂Â§öÂπ≥Âè∞ manifest
            # ‰ΩøÁî® stdbuf Á°Æ‰øùËæìÂá∫ÂÆûÊó∂Âà∑Êñ∞ÔºåÊ∑ªÂä†Ë∂ÖÊó∂‰øùÊä§Ôºà10ÂàÜÈíüÔºâ
            start_time=$(date +%s)
            
            # Âú®ÂêéÂè∞ËøêË°åËøõÂ∫¶ÁõëÊéßÔºàÊØè30ÁßíËæìÂá∫‰∏ÄÊ¨°ÂøÉË∑≥Ôºâ
            (
              while true; do
                sleep 30
                elapsed=$(($(date +%s) - start_time))
                echo "  ‚è≥ Still syncing... (${elapsed}s elapsed)" >&2
              done
            ) &
            progress_pid=$!
            
            # ÊâßË°åÂêåÊ≠•ÂëΩ‰ª§Ôºå‰ΩøÁî® stdbuf Á°Æ‰øùËæìÂá∫ÂÆûÊó∂Âà∑Êñ∞
            sync_output=$(mktemp)
            if timeout 600 stdbuf -oL -eL docker buildx imagetools create \
              --tag "$target" \
              "$image" > "$sync_output" 2>&1; then
              # ÂÅúÊ≠¢ËøõÂ∫¶ÁõëÊéß
              kill $progress_pid 2>/dev/null || true
              wait $progress_pid 2>/dev/null || true
              
              # ÊòæÁ§∫ËæìÂá∫ÔºàËøáÊª§ÊéâÈáçÂ§çÁöÑ copying ‰ø°ÊÅØÔºåÂè™ÊòæÁ§∫ÂÖ≥ÈîÆ‰ø°ÊÅØÔºâ
              if grep -q "digest:" "$sync_output" || grep -q "sha256:" "$sync_output"; then
                echo "  ‚úÖ Synced successfully"
                # ÊòæÁ§∫ÊëòË¶Å‰ø°ÊÅØ
                grep -E "(digest:|sha256:)" "$sync_output" | head -3 | sed 's/^/    /' || true
              else
                echo "  ‚úÖ Synced (output saved)"
                tail -10 "$sync_output" | sed 's/^/    /' || true
              fi
              
              end_time=$(date +%s)
              duration=$((end_time - start_time))
              echo "  ‚è±Ô∏è  Completed in ${duration}s"
              success_list="${success_list}${image} -> ${target}\n"
              ((success_count++))
            else
              exit_code=$?
              # ÂÅúÊ≠¢ËøõÂ∫¶ÁõëÊéß
              kill $progress_pid 2>/dev/null || true
              wait $progress_pid 2>/dev/null || true
              
              end_time=$(date +%s)
              duration=$((end_time - start_time))
              
              if [[ $exit_code -eq 124 ]]; then
                echo "  ‚è±Ô∏è  Timeout after ${duration}s"
                failed_list="${failed_list}${image} (timeout)\n"
              else
                echo "  ‚ùå Failed (exit code: $exit_code, took ${duration}s)"
                # ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                echo "  Error output:"
                tail -20 "$sync_output" | sed 's/^/    /' || true
                failed_list="${failed_list}${image}\n"
              fi
              ((failed_count++))
            fi
            
            # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
            rm -f "$sync_output"
          done

          # ËæìÂá∫Âà∞ GitHub ÁéØÂ¢ÉÂèòÈáè
          echo "success_count=$success_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT

          # ‰ΩøÁî® heredoc ‰øùÂ≠òÂ§öË°åÂÜÖÂÆπ
          {
            echo "success_list<<EOF"
            echo -e "$success_list"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "failed_list<<EOF"
            echo -e "$failed_list"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          echo ""
          echo "üìä Summary: $success_count succeeded, $failed_count failed"

          # Â¶ÇÊûúÂÖ®ÈÉ®Â§±Ë¥•ÂàôÈÄÄÂá∫
          [[ $success_count -eq 0 && $failed_count -gt 0 ]] && exit 1
          exit 0

      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üöÄ Image Sync Results

          | Metric | Value |
          |--------|-------|
          | ‚úÖ Succeeded | ${{ steps.sync.outputs.success_count || 0 }} |
          | ‚ùå Failed | ${{ steps.sync.outputs.failed_count || 0 }} |
          | Registry | `${{ env.REGISTRY }}` |
          | Namespace | `${{ env.NAMESPACE }}` |

          EOF

          if [[ -n "${{ steps.sync.outputs.success_list }}" ]]; then
            echo "### ‚úÖ Succeeded" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.sync.outputs.success_list }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ steps.sync.outputs.failed_list }}" ]]; then
            echo "### ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.sync.outputs.failed_list }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
