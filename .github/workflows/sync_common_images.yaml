name: Sync Common Images

on:
  workflow_dispatch:

env:
  REGISTRY: ${{ vars.ALIYUN_CR_REGISTRY }}
  NAMESPACE: ${{ vars.ALIYUN_CR_NAMESPACE_MODU }}
  COMMON_IMAGES: ${{ vars.ALIYUN_CR_COMMON_IMAGES }}

jobs:
  sync-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_CR_USERNAME }}
          password: ${{ secrets.ALIYUN_CR_PASSWORD }}

      - name: Parse and validate image list
        run: |
          IMAGE_LIST="${{ env.COMMON_IMAGES }}"

          echo "üîç Debug info:"
          echo "- IMAGE_LIST: '$IMAGE_LIST'"
          echo "- REGISTRY: '${{ env.REGISTRY }}'"
          echo "- NAMESPACE: '${{ env.NAMESPACE }}'"

          if [[ -z "$IMAGE_LIST" ]]; then
            echo "‚ùå Error: COMMON_IMAGES environment variable is not set or empty"
            exit 1
          fi

          # Ëß£ÊûêÈïúÂÉèÂàóË°®Âπ∂Â≠òÂÇ®Âà∞Êï∞ÁªÑ
          IFS=',' read -ra IMAGE_ARRAY <<< "$IMAGE_LIST"

          echo "üìã Raw images: ${IMAGE_ARRAY[*]}"

          # ÂàõÂª∫Êï∞ÁªÑÂ≠òÂÇ®ÊúâÊïàÈïúÂÉè
          declare -a VALID_IMAGES

          for image in "${IMAGE_ARRAY[@]}"; do
            # ÁßªÈô§Á©∫Ê†º
            image=$(echo "$image" | xargs | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

            if [[ -n "$image" ]]; then
              # Ê£ÄÊü•ÈïúÂÉèÊòØÂê¶ÂåÖÂê´Ê†áÁ≠æ
              if [[ "$image" == *":"* ]]; then
                VALID_IMAGES+=("$image")
                echo "‚úÖ Added image: $image"
              else
                # Â¶ÇÊûúÊ≤°ÊúâÊ†áÁ≠æÔºåËá™Âä®Ê∑ªÂä† :latest
                image_with_tag="${image}:latest"
                VALID_IMAGES+=("$image_with_tag")
                echo "‚úÖ Added image: $image_with_tag (auto-added :latest tag)"
              fi
            fi
          done

          if [[ ${#VALID_IMAGES[@]} -eq 0 ]]; then
            echo "‚ùå Error: No valid images found"
            exit 1
          fi

          # Â∞ÜÈïúÂÉèÂàóË°®ÂÜôÂÖ•ÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂
          printf "%s\n" "${VALID_IMAGES[@]}" > /tmp/images.txt
          echo "Found ${#VALID_IMAGES[@]} valid images"

          # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
          echo "IMAGE_COUNT=${#VALID_IMAGES[@]}" >> $GITHUB_ENV

      - name: Pull and push images
        run: |
          # ÂêØÁî® Docker Buildx Â§öÂπ≥Âè∞ÊûÑÂª∫
          docker buildx create --name multiarch --driver docker-container --use
          docker buildx inspect --bootstrap

          echo "üöÄ Starting image synchronization..."

          # ÂàõÂª∫Êñá‰ª∂ËÆ∞ÂΩïÊàêÂäüÂíåÂ§±Ë¥•ÁöÑÈïúÂÉè
          echo "# Successfully synchronized images" > /tmp/success_images.txt
          echo "# Failed to synchronize images" > /tmp/failed_images.txt

          success_count=0
          failed_count=0

          while IFS= read -r original_image; do
            if [[ -n "$original_image" ]]; then
              echo ""
              echo "üì¶ Processing: $original_image"

              # Â§ÑÁêÜÈïúÂÉèÂêçÁß∞ÔºöÂ∞Ü namespace ÊõøÊç¢‰∏∫ËøûÂ≠óÁ¨¶
              # ‰æãÂ¶ÇÔºödaytonaio/daytona-api:latest -> daytonaio-daytona-api:latest
              if [[ "$original_image" == *"/"* ]]; then
                # ÁßªÈô§ registry ÈÉ®ÂàÜÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if [[ "$original_image" == *"."*"/"* ]]; then
                  # Ê†ºÂºèÂ¶ÇÔºöregistry.com/namespace/image:tag
                  image_without_registry=$(echo "$original_image" | cut -d'/' -f2-)
                else
                  # Ê†ºÂºèÂ¶ÇÔºönamespace/image:tag
                  image_without_registry="$original_image"
                fi

                # Â∞ÜÊñúÊù†ÊõøÊç¢‰∏∫ËøûÂ≠óÁ¨¶
                transformed_name=$(echo "$image_without_registry" | sed 's/\//-/g')
              else
                # ÁÆÄÂçïÊ†ºÂºèÂ¶ÇÔºöredis:latest
                transformed_name="$original_image"
              fi

              target_image="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/$transformed_name"

              echo "  Original: $original_image"
              echo "  Target:   $target_image"

              sync_success=true
              error_message=""

              # ÊãâÂèñÈïúÂÉèÔºàÊîØÊåÅÂ§öÂπ≥Âè∞Ôºâ
              echo "  üîΩ Pulling image for amd64 and arm64..."
              if ! docker buildx imagetools inspect "$original_image" > /dev/null 2>&1; then
                sync_success=false
                error_message="Image does not exist or is not accessible"
                echo "  ‚ùå Error: $error_message"
              else
                # ‰ΩøÁî® docker pull ÊãâÂèñÈïúÂÉè
                if ! docker pull --platform linux/amd64,linux/arm64 "$original_image"; then
                  echo "  ‚ùå Error: Failed to pull $original_image for all platforms"
                  echo "  üîÑ Trying to pull for default platform..."
                  if ! docker pull "$original_image"; then
                    sync_success=false
                    error_message="Failed to pull image"
                    echo "  ‚ùå Error: $error_message"
                  fi
                fi

                if [[ "$sync_success" == true ]]; then
                  # Ê†áËÆ∞ÈïúÂÉè
                  echo "  üè∑Ô∏è Tagging image..."
                  if ! docker tag "$original_image" "$target_image"; then
                    sync_success=false
                    error_message="Failed to tag image"
                    echo "  ‚ùå Error: $error_message"
                  else
                    # Êé®ÈÄÅÈïúÂÉè
                    echo "  üîº Pushing image..."
                    if ! docker push "$target_image"; then
                      sync_success=false
                      error_message="Failed to push image"
                      echo "  ‚ùå Error: $error_message"
                    fi
                  fi
                fi
              fi

              # ËÆ∞ÂΩïÁªìÊûú
              if [[ "$sync_success" == true ]]; then
                echo "‚úÖ $original_image -> $target_image" >> /tmp/success_images.txt
                echo "  ‚úÖ Successfully synced: $target_image"
                ((success_count++))
              else
                echo "‚ùå $original_image - $error_message" >> /tmp/failed_images.txt
                echo "  ‚ùå Failed to sync: $error_message"
                ((failed_count++))
              fi

              # Ê∏ÖÁêÜÊú¨Âú∞ÈïúÂÉè‰ª•ËäÇÁúÅÁ©∫Èó¥
              docker rmi "$original_image" "$target_image" 2>/dev/null || true
            fi
          done < /tmp/images.txt

          # Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØÂà∞ÁéØÂ¢ÉÂèòÈáè
          echo "SUCCESS_COUNT=$success_count" >> $GITHUB_ENV
          echo "FAILED_COUNT=$failed_count" >> $GITHUB_ENV

      - name: Sync summary
        run: |
          echo "## üöÄ Image Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Sync Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Images:** ${{ env.IMAGE_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **‚úÖ Successful:** ${{ env.SUCCESS_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **‚ùå Failed:** ${{ env.FAILED_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace:** ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ÊòæÁ§∫ÊàêÂäüÁöÑÈïúÂÉè
          if [[ ${{ env.SUCCESS_COUNT }} -gt 0 ]]; then
            echo "### ‚úÖ Successfully Synchronized Images (${{ env.SUCCESS_COUNT }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r line; do
              # Ë∑≥ËøáÊ≥®ÈáäË°å
              if [[ "$line" == "#"* ]]; then
                continue
              fi
              if [[ -n "$line" ]]; then
                # Ëß£ÊûêÊ†ºÂºè: ‚úÖ original_image -> target_image
                original_image=$(echo "$line" | sed 's/‚úÖ \(.*\) -> .*/\1/')
                target_image=$(echo "$line" | sed 's/.* -> \(.*\)/\1/')
                echo "- **$original_image**" >> $GITHUB_STEP_SUMMARY
                echo "  ‚Üí \`$target_image\`" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done < /tmp/success_images.txt
          fi

          # ÊòæÁ§∫Â§±Ë¥•ÁöÑÈïúÂÉè
          if [[ ${{ env.FAILED_COUNT }} -gt 0 ]]; then
            echo "### ‚ùå Failed Synchronized Images (${{ env.FAILED_COUNT }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r line; do
              # Ë∑≥ËøáÊ≥®ÈáäË°å
              if [[ "$line" == "#"* ]]; then
                continue
              fi
              if [[ -n "$line" ]]; then
                # Ëß£ÊûêÊ†ºÂºè: ‚ùå original_image - error_message
                original_image=$(echo "$line" | sed 's/‚ùå \(.*\) - .*/\1/')
                error_message=$(echo "$line" | sed 's/.* - \(.*\)/\1/')
                echo "- **$original_image**" >> $GITHUB_STEP_SUMMARY
                echo "  ‚ö†Ô∏è $error_message" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done < /tmp/failed_images.txt
          fi

          # ÊòæÁ§∫‰ΩøÁî®Á§∫‰æãÔºà‰ªÖÊòæÁ§∫ÊàêÂäüÁöÑÈïúÂÉèÔºâ
          if [[ ${{ env.SUCCESS_COUNT }} -gt 0 ]]; then
            echo "### üìù Usage Examples" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Pull successfully synced images" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r line; do
              # Ë∑≥ËøáÊ≥®ÈáäË°å
              if [[ "$line" == "#"* ]]; then
                continue
              fi
              if [[ -n "$line" ]]; then
                target_image=$(echo "$line" | sed 's/.* -> \(.*\)/\1/')
                echo "docker pull $target_image" >> $GITHUB_STEP_SUMMARY
              fi
            done < /tmp/success_images.txt
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          # Â¶ÇÊûúÊúâÂ§±Ë¥•ÁöÑÈïúÂÉèÔºåÊ∑ªÂä†ÊïÖÈöúÊéíÈô§ÊèêÁ§∫
          if [[ ${{ env.FAILED_COUNT }} -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üîß Troubleshooting Tips" >> $GITHUB_STEP_SUMMARY
            echo "- Check if the source images exist and are accessible" >> $GITHUB_STEP_SUMMARY
            echo "- Verify network connectivity to Docker Hub or other registries" >> $GITHUB_STEP_SUMMARY
            echo "- Check if you have sufficient permissions to push to the target registry" >> $GITHUB_STEP_SUMMARY
            echo "- Review the workflow logs for detailed error messages" >> $GITHUB_STEP_SUMMARY
          fi