name: modu-sandbox-slim

on:
  workflow_dispatch:
    inputs:
      push_mode:
        description: 'Push mode'
        required: true
        type: choice
        options:
          - 'tag_only'
          - 'latest_only'
          - 'both'
        default: 'tag_only'
      image_tag:
        description: 'Image tag (required for tag_only and both modes)'
        required: false
        type: string
        default: ''
      description:
        description: 'Description of the image'
        required: false
        type: string
        default: 'Modu Sandbox Slim Image'
env:
  REGISTRY: ${{ secrets.ALIYUN_CR_REGISTRY }}
  NAMESPACE: ${{ secrets.ALIYUN_CR_NAMESPACE_MODU }}
  IMAGE_NAME: modu-sandbox-slim

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_CR_USERNAME }}
          password: ${{ secrets.ALIYUN_CR_PASSWORD }}

      - name: Validate inputs
        run: |
          PUSH_MODE="${{ github.event.inputs.push_mode }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"

          echo "ğŸ” Debug info:"
          echo "- PUSH_MODE: '$PUSH_MODE'"
          echo "- IMAGE_TAG: '$IMAGE_TAG'"
          echo "- REGISTRY: '${{ env.REGISTRY }}'"
          echo "- NAMESPACE: '${{ env.NAMESPACE }}'"
          echo "- IMAGE_NAME: '${{ env.IMAGE_NAME }}'"

          # éªŒè¯è¾“å…¥å‚æ•°
          if [[ "$PUSH_MODE" == "tag_only" || "$PUSH_MODE" == "both" ]]; then
            if [[ -z "$IMAGE_TAG" ]]; then
              echo "âŒ Error: image_tag is required for $PUSH_MODE mode"
              exit 1
            fi
          fi

          # è®¾ç½®æ¨é€çš„æ ‡ç­¾
          case "$PUSH_MODE" in
            "tag_only")
              TAGS="$IMAGE_TAG"
              ;;
            "latest_only")
              TAGS="latest"
              ;;
            "both")
              TAGS="$IMAGE_TAG,latest"
              ;;
          esac

          echo "PUSH_TAGS=$TAGS" >> $GITHUB_ENV
          echo "PUSH_MODE=$PUSH_MODE" >> $GITHUB_ENV
          echo "âœ… Will push with tags: $TAGS"

      - name: Prepare tags
        id: tags
        run: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡å·²æ­£ç¡®è®¾ç½®
          if [[ -z "${{ env.REGISTRY }}" || -z "${{ env.NAMESPACE }}" || -z "${{ env.IMAGE_NAME }}" ]]; then
            echo "âŒ Error: Missing required environment variables"
            echo "REGISTRY: '${{ env.REGISTRY }}'"
            echo "NAMESPACE: '${{ env.NAMESPACE }}'"
            echo "IMAGE_NAME: '${{ env.IMAGE_NAME }}'"
            exit 1
          fi

          # å‡†å¤‡æ¨é€çš„æ ‡ç­¾
          IFS=',' read -ra TAG_ARRAY <<< "${{ env.PUSH_TAGS }}"

          echo "ğŸ“‹ Raw PUSH_TAGS: '${{ env.PUSH_TAGS }}'"
          echo "ğŸ“‹ TAG_ARRAY: ${TAG_ARRAY[*]}"

          # åˆ›å»ºæ•°ç»„å­˜å‚¨æ‰€æœ‰æ ‡ç­¾
          declare -a FULL_TAGS

          for tag in "${TAG_ARRAY[@]}"; do
            # ç§»é™¤å¯èƒ½çš„ç©ºæ ¼å’Œå‰åç¼€
            tag=$(echo "$tag" | xargs | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

            if [[ -n "$tag" ]]; then
              FULL_TAG="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:$tag"
              FULL_TAGS+=("$FULL_TAG")
              echo "âœ… Added tag: $FULL_TAG"
            fi
          done

          # ç”¨é€—å·è¿æ¥æ‰€æœ‰æ ‡ç­¾
          if [[ ${#FULL_TAGS[@]} -gt 0 ]]; then
            TAG_ARGS=$(IFS=','; echo "${FULL_TAGS[*]}")
          else
            echo "âŒ Error: No valid tags found"
            exit 1
          fi

          echo "tags=$TAG_ARGS" >> $GITHUB_OUTPUT
          echo "ğŸ“ Final tags: $TAG_ARGS"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./modu-sandbox/modu-sandbox-slim
          file: ./modu-sandbox/modu-sandbox-slim/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          labels: |
            description=${{ github.event.inputs.description }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build summary
        run: |
          echo "## ğŸš€ Build and Push Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Image Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace:** ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Name:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Push Mode:** ${{ env.PUSH_MODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags Pushed:** ${{ env.PUSH_TAGS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ˜¾ç¤ºæ‰€æœ‰æ¨é€çš„é•œåƒ
          IFS=',' read -ra TAG_ARRAY <<< "${{ env.PUSH_TAGS }}"
          echo "### ğŸ·ï¸ Pushed Images" >> $GITHUB_STEP_SUMMARY
          for tag in "${TAG_ARRAY[@]}"; do
            echo "- \`docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:$tag\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ” Authentication" >> $GITHUB_STEP_SUMMARY
          echo "- **Username:** ${{ secrets.ALIYUN_USERNAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“‹ Usage Examples" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          # æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„ä½¿ç”¨ç¤ºä¾‹
          case "${{ env.PUSH_MODE }}" in
            "tag_only")
              echo "# Pull specific version" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${TAG_ARRAY[0]}" >> $GITHUB_STEP_SUMMARY
              ;;
            "latest_only")
              echo "# Pull latest version" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
              ;;
            "both")
              echo "# Pull specific version" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${TAG_ARRAY[0]}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "# Pull latest version" >> $GITHUB_STEP_SUMMARY
              echo "docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY